
<!DOCTYPE HTML>
<html lang="en" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Exchange docking · Simplechain Documentation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-language-picker/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="41_commityProduct.html" />
    
    
    <link rel="prev" href="39_blockBrowser/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Quick Start</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="1_quickStart.html">
            
                <a href="1_quickStart.html">
            
                    
                    Quick Start
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="2_BuildNode/">
            
                <a href="2_BuildNode/">
            
                    
                    Build Node
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Sipc Coin Negotiate</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="47_techniqueLanguage.html">
            
                <a href="47_techniqueLanguage.html">
            
                    
                    Technical Manual
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="3_sipcCoin.html">
            
                <a href="3_sipcCoin.html">
            
                    
                    Sipc Coin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="4_PublishCoin/">
            
                <a href="4_PublishCoin/">
            
                    
                    Publish Coin
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Basic Data Struct</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="5_concoct.html">
            
                <a href="5_concoct.html">
            
                    
                    Deploy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="6_genesis/">
            
                <a href="6_genesis/">
            
                    
                    Genesis Block
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="7_account.html">
            
                <a href="7_account.html">
            
                    
                    Account
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="8_transaction/">
            
                <a href="8_transaction/">
            
                    
                    Transaction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="9_block/">
            
                <a href="9_block/">
            
                    
                    Block
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="10_transactionReceipt/">
            
                <a href="10_transactionReceipt/">
            
                    
                    Transaction Receipt
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Construct</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="11_constructDesign/">
            
                <a href="11_constructDesign/">
            
                    
                    Structure Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="12_structAndStore/">
            
                <a href="12_structAndStore/">
            
                    
                    Data Struct and 
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="50_togetherStep.html">
            
                <a href="50_togetherStep.html">
            
                    
                    Data Synchronize
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Underlying Core Technology</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="13_p2pNetwork.html">
            
                <a href="13_p2pNetwork.html">
            
                    
                    p2p network
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="14_consensus/">
            
                <a href="14_consensus/">
            
                    
                    Consensus mechanism
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="15_virtualMache/">
            
                <a href="15_virtualMache/">
            
                    
                    virtual machine
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.4" data-path="16_runMechanism/">
            
                <a href="16_runMechanism/">
            
                    
                    Operating mechanism
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.5" data-path="17_unusual.html">
            
                <a href="17_unusual.html">
            
                    
                    Handle exceptions
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Smart contract</li>
        
        
    
        <li class="chapter " data-level="7.1" data-path="18_contract/">
            
                <a href="18_contract/">
            
                    
                    Smart contract
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.2" data-path="19_understandSolidity/">
            
                <a href="19_understandSolidity/">
            
                    
                    understand Solidity
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.3" data-path="20_contractPattern.html">
            
                <a href="20_contractPattern.html">
            
                    
                    Contract template
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Developer tools</li>
        
        
    
        <li class="chapter " data-level="8.1" data-path="21_buildTest.html">
            
                <a href="21_buildTest.html">
            
                    
                    Build Test network
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.2" data-path="22_sipcApi.html">
            
                <a href="22_sipcApi.html">
            
                    
                    Sip API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.3" data-path="23_crossChainApi.html">
            
                <a href="23_crossChainApi.html">
            
                    
                    Cross-chain API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.4" data-path="24_chromeWallet/">
            
                <a href="24_chromeWallet/">
            
                    
                    SimPlug
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.5" data-path="25_sdk/">
            
                <a href="25_sdk/">
            
                    
                    SDK
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Cross-chain</li>
        
        
    
        <li class="chapter " data-level="9.1" data-path="48_crossChain/">
            
                <a href="48_crossChain/">
            
                    
                    Cross-chain solution
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="9.2" data-path="26_smallChain.html">
            
                <a href="26_smallChain.html">
            
                    
                    Subchain template
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="9.3" data-path="49_crossChainOrder/">
            
                <a href="49_crossChainOrder/">
            
                    
                    Cross-chain process
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Dapp develop</li>
        
        
    
        <li class="chapter " data-level="10.1" data-path="27_dappFlow/">
            
                <a href="27_dappFlow/">
            
                    
                    Dapp process carding
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="10.2" data-path="28_editor.html">
            
                <a href="28_editor.html">
            
                    
                    translater
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="10.3" data-path="29_writeContract/">
            
                <a href="29_writeContract/">
            
                    
                    Write contract
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="10.4" data-path="30_frontRealize/">
            
                <a href="30_frontRealize/">
            
                    
                    Front-end development
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Mining</li>
        
        
    
        <li class="chapter " data-level="11.1" data-path="31_mining.html">
            
                <a href="31_mining.html">
            
                    
                    sipc mining
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="11.2" data-path="32_miningPool/">
            
                <a href="32_miningPool/">
            
                    
                    MinePool access
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="11.3" data-path="33_gpuMining/">
            
                <a href="33_gpuMining/">
            
                    
                    GPU Mining
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="11.4" data-path="34_SimPool/">
            
                <a href="34_SimPool/">
            
                    
                    Simpool Mining
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="11.5" data-path="35_SimpleNode_x1/">
            
                <a href="35_SimpleNode_x1/">
            
                    
                    SimpleNode x1 Mining
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Client</li>
        
        
    
        <li class="chapter " data-level="12.1" data-path="36_SIPC.html">
            
                <a href="36_SIPC.html">
            
                    
                    SIPC.VIP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="12.2" data-path="37_wallet/">
            
                <a href="37_wallet/">
            
                    
                    Sipc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="12.3" data-path="38_ChainBox/">
            
                <a href="38_ChainBox/">
            
                    
                    ChainBox
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="12.4" data-path="39_blockBrowser/">
            
                <a href="39_blockBrowser/">
            
                    
                    Explore
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Ecology</li>
        
        
    
        <li class="chapter active" data-level="13.1" data-path="40_tradePlateform.html">
            
                <a href="40_tradePlateform.html">
            
                    
                    Exchange docking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="13.2" data-path="41_commityProduct.html">
            
                <a href="41_commityProduct.html">
            
                    
                    Community Project
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="13.3" data-path="42_commityActity.html">
            
                <a href="42_commityActity.html">
            
                    
                    Community Activity
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="13.4" data-path="43_commityEnters/">
            
                <a href="43_commityEnters/">
            
                    
                    Community Entrance
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Landing scheme</li>
        
        
    
        <li class="chapter " data-level="14.1" data-path="44_case.html">
            
                <a href="44_case.html">
            
                    
                    Landing case
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Other</li>
        
        
    
        <li class="chapter " data-level="15.1" data-path="45_faq.html">
            
                <a href="45_faq.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="15.2" data-path="46_supportOnline/">
            
                <a href="46_supportOnline/">
            
                    
                    Online technical support
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Exchange docking</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="build-simplechain-nodes"><a name="build-simplechain-nodes" class="plugin-anchor" href="#build-simplechain-nodes"><i class="fa fa-link" aria-hidden="true"></i></a>Build SimpleChain nodes</h2>
<h3 id="docker-build"><a name="docker-build" class="plugin-anchor" href="#docker-build"><i class="fa fa-link" aria-hidden="true"></i></a>docker build</h3>
<p><strong>Obtain an image:</strong></p>
<pre><code class="lang-sh">docker pull simplechain/sipe:latest
</code></pre>
<p><strong>Enable RPC</strong></p>
<pre><code class="lang-sh">docker run -it -p 8545:8545 -p 30312:30312 simplechain/sipe --rpc --rpcaddr <span class="hljs-string">&quot;0.0.0.0&quot;</span>
</code></pre>
<p>You can run the following command to check whether your node is successfully started:</p>
<pre><code class="lang-sh">curl -X POST localhost:8545  -H <span class="hljs-string">&quot;Content-Type:application/json&quot;</span> --data <span class="hljs-string">&apos;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;web3_clientVersion&quot;,&quot;params&quot;:[],&quot;id&quot;:68}&apos;</span>
</code></pre>
<h3 id="source-code-construction"><a name="source-code-construction" class="plugin-anchor" href="#source-code-construction"><i class="fa fa-link" aria-hidden="true"></i></a>Source code construction</h3>
<p><code>Preliminary preparations: Go language environment (1.10 or above), C language compiler</code></p>
<p><strong>1.Download SimpleChain</strong></p>
<p>You can clone a project locally through git or download directly from the <a href="https://github.com/simplechain-org/go-" target="_blank">https://github.com/simplechain-org/go-</a>
simplechain page.</p>
<pre><code>git clone https://github.com/simplechain-org/go-simplechain.git 
</code></pre><p><strong>2.Install sipe</strong></p>
<p>1.Enter the go-simplechain root directory.</p>
<pre><code class="lang-javascript">cd go-simplechain
</code></pre>
<p>2.Use the make tool to install sipe.</p>
<pre><code>make sipe
&gt;&gt;&gt; /usr/local/go/bin/go install -ldflags -X main.gitCommit=9d73f67e1dc5587a95f52c13fee93be6434b42ac -s -v ./cmd/sipe github.com/simplechain-org/go-simplechain/core
...
github.com/simplechain-org/go-simplechain/cmd/sipe
Done building.
Run &quot;/Users/yuanchao/go/src/github.com/simplechain-org/go-simplechain/build/bin/sipe&quot; to launch sipe.
</code></pre><p>When the above output appears on the terminal, the make execution is successful. In this case, the sipe executable file is generated in the go-simplechain/build/bin directory. You can move it to any directory or add it to environment variables to facilitate the running of sipe programs.</p>
<h2 id="start-sipe"><a name="start-sipe" class="plugin-anchor" href="#start-sipe"><i class="fa fa-link" aria-hidden="true"></i></a>Start sipe</h2>
<p><strong>1.Create a folder for storing node data, if not</strong></p>
<pre><code>mkdir chaindata
</code></pre><p><strong>2.Start the sipe Master network node</strong></p>
<p>Enable the RPC service and specify the RPC listening address as 127.0.0.1, Port 8545 . The node data storage directory is <code>chaindata</code></p>
<pre><code class="lang-bash">./sipe --rpc --rpcaddr 127.0.0.1 --rpcport 8545 --datadir chaindata
</code></pre>
<p>When an output similar to the following appears, the startup is successful and the SimpleChain master Network block is synchronized.</p>
<pre><code class="lang-bash">INFO [06-19|09:35:01.481] Maximum peer count               ETH=25 LES=0 total=25
INFO [06-19|09:35:01.492] Starting peer-to-peer node       instance=Sipe/v1.0.2-stable-0cbf2a41/darwin-amd64/go1.12.1
...
INFO [06-19|09:35:33.700] Block synchronisation started
INFO [06-19|09:35:36.756] Imported new block headers       count=192\
elapsed=22.273ms number=192 <span class="hljs-built_in">hash</span>=bb758a...bea1b6 ignored=0
</code></pre>
<h2 id="community-node"><a name="community-node" class="plugin-anchor" href="#community-node"><i class="fa fa-link" aria-hidden="true"></i></a>Community node</h2>
<p><strong>rpc address and port number:</strong></p>
<pre><code class="lang-bash">47.110.48.207:8545
</code></pre>
<p><strong>Test:</strong></p>
<pre><code class="lang-json"><span class="hljs-comment">//Request</span>
curl -X POST <span class="hljs-number">47.110</span><span class="hljs-number">.48</span><span class="hljs-number">.207</span>:<span class="hljs-number">8545</span>  -H <span class="hljs-string">&quot;Content-Type:application/json&quot;</span> --data <span class="hljs-string">&apos;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;web3_clientVersion&quot;,&quot;params&quot;:[],&quot;id&quot;:68}&apos;</span>
<span class="hljs-comment">//Response</span>
{
    <span class="hljs-string">&quot;jsonrpc&quot;</span>: <span class="hljs-string">&quot;2.0&quot;</span>,
    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">68</span>,
    <span class="hljs-string">&quot;result&quot;</span>: <span class="hljs-string">&quot;Sipe/v1.1.0-stable-0800d402/linux-amd64/go1.14.1&quot;</span>
}
</code></pre>
<h2 id="connect-to-the-simplechain-node"><a name="connect-to-the-simplechain-node" class="plugin-anchor" href="#connect-to-the-simplechain-node"><i class="fa fa-link" aria-hidden="true"></i></a>Connect to the SimpleChain node</h2>
<p>Create a sipc.js file and write the following code:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;../../config&apos;</span>) <span class="hljs-comment">//Node serve compile information</span>
<span class="hljs-keyword">const</span> Web3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;web3&apos;</span>)
<span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">new</span> Web3(config.uri)
</code></pre>
<h2 id="create-simplechain-wallet-service"><a name="create-simplechain-wallet-service" class="plugin-anchor" href="#create-simplechain-wallet-service"><i class="fa fa-link" aria-hidden="true"></i></a>Create SimpleChain wallet service</h2>
<p>Now we are entering the development phase of the core features of Simplechain wallet service.</p>
<h3 id="create-a-new-simplechain-account"><a name="create-a-new-simplechain-account" class="plugin-anchor" href="#create-a-new-simplechain-account"><i class="fa fa-link" aria-hidden="true"></i></a>Create a new Simplechain account</h3>
<p>The exchange and payment gateway need to generate a new address for the customer so that the user can recharge the service or pay for the product. Generate an unused sipc Address is the basic requirement of any digital asset service, so let&apos;s take a look at the specific implementation.</p>
<p>First, create a command.js where we subscribe to messages in the queue. It mainly includes the following steps:</p>
<p>Connect to the command topic and listen to the new create_account command When a new create_account command is received, a new key pair is created and stored in the password library.</p>
<p>The account_created topic that generates the account_created message and sends it to the queue.
The code is as follows:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> web3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./ethereum&quot;</span>)
<span class="hljs-comment">/**
 * Create a new ethereum address and return the address 
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create_account</span>(<span class="hljs-params">meta = {}</span>) </span>{
  <span class="hljs-comment">// generate the address</span>
  <span class="hljs-keyword">const</span> account = <span class="hljs-keyword">await</span> web3.eth.accounts.create()

  <span class="hljs-comment">// disable checksum when storing the address</span>
  <span class="hljs-keyword">const</span> address = account.address.toLowerCase()

  <span class="hljs-comment">// save the public address in Redis without any transactions received yet</span>
  <span class="hljs-keyword">await</span> redis.setAsync(<span class="hljs-string">`eth:address:public:<span class="hljs-subst">${address}</span>`</span>, <span class="hljs-built_in">JSON</span>.stringify({}))

  <span class="hljs-comment">// Store the private key in a vault.</span>
  <span class="hljs-comment">// For demo purposes we use the same Redis instance, but this should be changed in production</span>
  <span class="hljs-keyword">await</span> redis.setAsync(<span class="hljs-string">`eth:address:private:<span class="hljs-subst">${address}</span>`</span>, account.privateKey)

  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.assign({}, meta, {address: account.address})
}

<span class="hljs-built_in">module</span>.exports.listen_to_commands = listen_to_commands
</code></pre>
<h3 id="handle-new-transactions"><a name="handle-new-transactions" class="plugin-anchor" href="#handle-new-transactions"><i class="fa fa-link" aria-hidden="true"></i></a>Handle new transactions</h3>
<p>We haven&apos;t finished our wallet yet. When the address we created receives the user&apos;s recharge, it should be notified. To this end, the web3 client of Simplechain provides the newBlockHeaders subscription mechanism. In addition, if our service goes down accidentally, the service will miss the blocks produced during the downtime. Therefore, we also need to check whether the wallet has been synchronized to the latest blocks on the network.</p>
<p>Create <code>sync_blocks.js</code> file, write the following code:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> web3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;./ethereum&apos;</span>)

<span class="hljs-comment">/**
 * Sync blocks and start listening for new blocks
 * @param {Number} current_block_number - The last block processed
 * @param {Object} opts - A list of options with callbacks for events
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sync_blocks</span>(<span class="hljs-params">current_block_number, opts</span>) </span>{
  <span class="hljs-comment">// first sync the wallet to the latest block</span>
  <span class="hljs-keyword">let</span> latest_block_number = <span class="hljs-keyword">await</span> web3.eth.getBlockNumber()
  <span class="hljs-keyword">let</span> synced_block_number = <span class="hljs-keyword">await</span> sync_to_block(current_block_number, latest_block_number, opts)

  <span class="hljs-comment">// subscribe to new blocks</span>
  web3.eth.subscribe(<span class="hljs-string">&apos;newBlockHeaders&apos;</span>, (error, result) =&gt; error &amp;&amp; <span class="hljs-built_in">console</span>.log(error))
  .on(<span class="hljs-string">&quot;data&quot;</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">blockHeader</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> process_block(blockHeader.number, opts)
  })

  <span class="hljs-keyword">return</span> synced_block_number
}

<span class="hljs-comment">// Load all data about the given block and call the callbacks if defined</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process_block</span>(<span class="hljs-params">block_hash_or_id, opts</span>) </span>{
  <span class="hljs-comment">// load block information by id or hash</span>
  <span class="hljs-keyword">const</span> block = <span class="hljs-keyword">await</span> web3.eth.getBlock(block_hash_or_id, <span class="hljs-literal">true</span>)
  <span class="hljs-comment">// call the onTransactions callback if defined</span>
  opts.onTransactions ? opts.onTransactions(block.transactions) : <span class="hljs-literal">null</span>;
  <span class="hljs-comment">// call the onBlock callback if defined</span>
  opts.onBlock ? opts.onBlock(block_hash_or_id) : <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">return</span> block
}

<span class="hljs-comment">// Traverse all unprocessed blocks between the current index and the lastest block number</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sync_to_block</span>(<span class="hljs-params">index, latest, opts</span>) </span>{
  <span class="hljs-keyword">if</span> (index &gt;= latest) {
    <span class="hljs-keyword">return</span> index;
  }
  <span class="hljs-keyword">await</span> process_block(index + <span class="hljs-number">1</span>, opts)
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> sync_to_block(index + <span class="hljs-number">1</span>, latest, opts)
}

<span class="hljs-built_in">module</span>.exports = sync_blocks
</code></pre>
<p>In the preceding code, we synchronize the latest block processed by the wallet service to the current latest block in the blockchain. Once we synchronize to the latest block, we begin to subscribe to the new Block event. For each block, we execute the following callback function to process the block header and the transaction list in the block:</p>
<ul>
<li><code>onTransactions</code></li>
<li><code>onBlock</code></li>
</ul>
<p><strong>Generally, the following processing steps are included:</strong></p>
<ul>
<li><code>Monitor new blocks and get all transactions in the block</code></li>
<li><code>Filter out transactions that are not related to the wallet address</code></li>
<li><code>Send every related transaction to the queue</code></li>
<li><code>Gather funds on the address to secure storage</code></li>
<li><code>Update processed block number</code></li>
</ul>
<p><strong>The final code is as follows:</strong></p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> web3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;web3&quot;</span>) <span class="hljs-comment">//&#x8C03;&#x7528;web3</span>
<span class="hljs-keyword">const</span> redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;./redis&apos;</span>) <span class="hljs-comment">//&#x8C03;&#x7528;redis&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x5C06;&#x533A;&#x5757;&#x6570;&#x636E;&#x83B7;&#x53D6;&#x4E0B;&#x6765;&#x5B58;&#x5165;redis&#x6570;&#x636E;&#x5E93;&#x4E2D;</span>
<span class="hljs-keyword">const</span> queue = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;./queue&apos;</span>) <span class="hljs-comment">//&#x8C03;&#x7528;&#x6D88;&#x606F;&#x961F;&#x5217;</span>
<span class="hljs-keyword">const</span> sync_blocks = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;./sync_blocks&apos;</span>)  <span class="hljs-comment">//&#x540C;&#x6B65;&#x533A;&#x5757;</span>

<span class="hljs-comment">/**
 * Start syncing blocks and listen for new transactions on the blockchain
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">start_syncing_blocks</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">// start from the last block number processed or 0 (you can use the current block before deploying for the first time)</span>
  <span class="hljs-keyword">let</span> last_block_number = <span class="hljs-keyword">await</span> redis.getAsync(<span class="hljs-string">&apos;eth:last-block&apos;</span>)
  last_block_number = last_block_number || <span class="hljs-number">0</span>
  <span class="hljs-comment">// start syncing blocks</span>
  sync_blocks(last_block_number, {
    <span class="hljs-comment">// for every new block update the latest block value in redis</span>
    onBlock: update_block_head,
    <span class="hljs-comment">// for new transactions check each transaction and see if it&apos;s new</span>
    onTransactions: <span class="hljs-keyword">async</span> (transactions) =&gt; {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i <span class="hljs-keyword">in</span> transactions) {
        <span class="hljs-keyword">await</span> process_transaction(transactions[i])
      }
    }
  })
}

<span class="hljs-comment">// save the lastest block on redis</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update_block_head</span>(<span class="hljs-params">head</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> redis.setAsync(<span class="hljs-string">&apos;eth:last-block&apos;</span>, head)
}

<span class="hljs-comment">// process a new transaction</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process_transaction</span>(<span class="hljs-params">transaction</span>) </span>{
  <span class="hljs-keyword">const</span> address = transaction.to.toLowerCase()
  <span class="hljs-keyword">const</span> amount_in_ether = web3.utils.fromWei(transaction.value)

  <span class="hljs-comment">// check if the receiving address has been generated by our wallet</span>
  <span class="hljs-keyword">const</span> watched_address = <span class="hljs-keyword">await</span> redis.existsAsync(<span class="hljs-string">`eth:address:public:<span class="hljs-subst">${address}</span>`</span>)
  <span class="hljs-keyword">if</span> (watched_address !== <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

  <span class="hljs-comment">// then check if it&apos;s a new transaction that should be taken into account</span>
  <span class="hljs-keyword">const</span> transaction_exists = <span class="hljs-keyword">await</span> redis.existsAsync(<span class="hljs-string">`eth:address:public:<span class="hljs-subst">${address}</span>`</span>)
  <span class="hljs-keyword">if</span> (transaction_exists === <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

  <span class="hljs-comment">// update the list of transactions for that address</span>
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> redis.getAsync(<span class="hljs-string">`eth:address:public:<span class="hljs-subst">${address}</span>`</span>)
  <span class="hljs-keyword">let</span> addr_data = <span class="hljs-built_in">JSON</span>.parse(data)
  addr_data[transaction.hash] = {
    value: amount_in_ether
  }

  <span class="hljs-keyword">await</span> redis.setAsync(<span class="hljs-string">`eth:address:public:<span class="hljs-subst">${address}</span>`</span>, <span class="hljs-built_in">JSON</span>.stringify(addr_data))
  <span class="hljs-keyword">await</span> redis.setAsync(<span class="hljs-string">`eth:transaction:<span class="hljs-subst">${transaction.hash}</span>`</span>, transaction)

  <span class="hljs-comment">// move funds to the cold wallet address</span>
  <span class="hljs-comment">// const cold_txid = await move_to_cold_storage(address, amount_in_ether)</span>

  <span class="hljs-comment">// send notification to the kafka server</span>
  <span class="hljs-keyword">await</span> queue_producer.send(<span class="hljs-string">&apos;transaction&apos;</span>, [{
    txid: transaction.hash,
    value: amount_in_ether,
    to: transaction.to,
    <span class="hljs-keyword">from</span>: transaction.from,
    <span class="hljs-comment">//cold_txid: cold_txid,</span>
  }])

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-built_in">module</span>.exports = start_syncing_blocks
</code></pre>
<h1 id="summary"><a name="summary" class="plugin-anchor" href="#summary"><i class="fa fa-link" aria-hidden="true"></i></a>Summary</h1>
<p>We have completed the design and implementation of Simplechain wallet service of the exchange. This service can also be improved from the following aspects:</p>
<ul>
<li>Add error handling</li>
<li>Add command type</li>
<li>Transaction Signature and transaction broadcast</li>
<li>Deployment Contract</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="39_blockBrowser/" class="navigation navigation-prev " aria-label="Previous page: Explore">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="41_commityProduct.html" class="navigation navigation-next " aria-label="Next page: Community Project">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"id":"docs_44","title":"Exchange docking","sidebar_label":"平台对接","level":"13.1","depth":1,"next":{"title":"Community Project","level":"13.2","depth":1,"path":"41_commityProduct.md","ref":"41_commityProduct.md","articles":[]},"previous":{"title":"Explore","level":"12.4","depth":1,"path":"39_blockBrowser/README.md","ref":"39_blockBrowser/README.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-lunr","-search","search-pro","language-picker","anchors"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"search-pro":{},"language-picker":{"grid-columns":3},"anchors":{},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Simplechain Documentation","language":"en","gitbook":"*"},"file":{"path":"40_tradePlateform.md","mtime":"2020-08-06T06:29:44.286Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-08-06T10:07:28.339Z"},"basePath":".","book":{"language":"en"}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-language-picker/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

